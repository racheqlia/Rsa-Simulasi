<html lang="id" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simulasi Kriptografi RSA - Enkripsi & Dekripsi TTD</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    textarea:focus,
    input:focus {
      outline: none;
      box-shadow: 0 0 0 3px #2563ebaa;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
  <header class="bg-white shadow-md sticky top-0 z-30">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-2xl font-semibold text-blue-700 flex items-center gap-2">
        <i class="fas fa-lock fa-lg"></i> Simulasi Kriptografi RSA
      </h1>
      <button
        id="btnExit"
        class="text-white bg-red-600 hover:bg-red-700 px-4 py-2 rounded-md flex items-center gap-2 transition"
        aria-label="Tutup aplikasi"
        title="Tutup aplikasi"
      >
        <i class="fas fa-sign-out-alt"></i> EXIT
      </button>
    </div>
  </header>

  <main class="flex-grow max-w-5xl mx-auto px-4 py-6 w-full">
    <section
      aria-label="Form input kunci publik RSA"
      class="bg-white rounded-lg shadow-md p-6 mb-6"
    >
      <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <i class="fas fa-key text-blue-600"></i> Input Kunci Publik RSA
      </h2>
      <form id="keyForm" class="grid grid-cols-1 sm:grid-cols-3 gap-6">
        <div>
          <label for="inputP" class="block text-gray-700 font-medium mb-1"
            >Bilangan Prima p</label
          >
          <input
            type="number"
            id="inputP"
            name="p"
            min="2"
            step="1"
            placeholder="Contoh: 61"
            class="w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-500"
            required
            aria-describedby="descP"
          />
          <p id="descP" class="text-xs text-gray-500 mt-1"
            >Masukkan bilangan prima p (≥ 2)</p
          >
        </div>
        <div>
          <label for="inputQ" class="block text-gray-700 font-medium mb-1"
            >Bilangan Prima q</label
          >
          <input
            type="number"
            id="inputQ"
            name="q"
            min="2"
            step="1"
            placeholder="Contoh: 53"
            class="w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-500"
            required
            aria-describedby="descQ"
          />
          <p id="descQ" class="text-xs text-gray-500 mt-1"
            >Masukkan bilangan prima q (≥ 2)</p
          >
        </div>
        <div>
          <label for="inputE" class="block text-gray-700 font-medium mb-1"
            >Bilangan e (kunci publik)</label
          >
          <input
            type="number"
            id="inputE"
            name="e"
            min="2"
            step="1"
            placeholder="Contoh: 17"
            class="w-full rounded-md border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-500"
            required
            aria-describedby="descE"
          />
          <p id="descE" class="text-xs text-gray-500 mt-1"
            >Masukkan bilangan e yang relatif prima dengan φ(n)</p
          >
        </div>
      </form>
      <p
        id="keyError"
        class="text-red-600 font-semibold mt-3 hidden"
        role="alert"
        aria-live="assertive"
      ></p>
    </section>

    <section
      aria-label="Form input dan output teks"
      class="bg-white rounded-lg shadow-md p-6 mb-6"
    >
      <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <i class="fas fa-file-alt text-blue-600"></i> Input & Output Teks
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="flex flex-col">
          <label for="inputText" class="font-medium text-gray-700 mb-1"
            >Teks Input</label
          >
          <textarea
            id="inputText"
            rows="6"
            placeholder="Masukkan teks yang ingin dienkripsi"
            class="resize-none rounded-md border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-500"
            aria-describedby="descInputText"
          ></textarea>
          <p id="descInputText" class="text-xs text-gray-500 mt-1"
            >Teks asli yang akan dienkripsi atau hasil dekripsi</p
          >
        </div>
        <div class="flex flex-col">
          <label for="outputText" class="font-medium text-gray-700 mb-1"
            >Hasil Output</label
          >
          <textarea
            id="outputText"
            rows="6"
            readonly
            placeholder="Hasil enkripsi atau dekripsi akan muncul di sini"
            class="resize-none rounded-md border border-gray-300 bg-gray-100 px-3 py-2"
            aria-describedby="descOutputText"
          ></textarea>
          <p id="descOutputText" class="text-xs text-gray-500 mt-1"
            >Hasil enkripsi atau dekripsi</p
          >
        </div>
      </div>
    </section>

    <section
      aria-label="Kontrol tombol aksi"
      class="bg-white rounded-lg shadow-md p-6 flex flex-col sm:flex-row justify-center gap-4"
    >
      <button
        id="btnEncrypt"
        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-md transition flex items-center justify-center gap-2"
        aria-label="Tombol enkripsi"
      >
        <i class="fas fa-lock"></i> ENKRIPSI
      </button>
      <button
        id="btnDecrypt"
        class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-md transition flex items-center justify-center gap-2"
        aria-label="Tombol dekripsi"
      >
        <i class="fas fa-unlock"></i> DEKRIPSI
      </button>
      <button
        id="btnReset"
        class="flex-1 bg-gray-400 hover:bg-gray-500 text-gray-900 font-semibold py-3 rounded-md transition flex items-center justify-center gap-2"
        aria-label="Tombol reset"
      >
        <i class="fas fa-undo-alt"></i> UBAH
      </button>
    </section>

    <section
      aria-label="Visualisasi proses"
      class="bg-white rounded-lg shadow-md p-6 mt-6"
    >
      <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <i class="fas fa-chart-bar text-blue-600"></i> Status Proses
      </h2>
      <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
        <div
          id="progressBar"
          class="bg-blue-600 h-6 w-0 transition-all duration-500"
          role="progressbar"
          aria-valuemin="0"
          aria-valuemax="100"
          aria-valuenow="0"
          aria-label="Bar progres proses"
        ></div>
      </div>
      <p
        id="progressText"
        class="mt-2 text-gray-700 font-medium text-center select-none"
      >
        Menunggu aksi pengguna...
      </p>
    </section>
  </main>

  <footer class="bg-white shadow-inner py-4 mt-auto">
    <div class="max-w-5xl mx-auto px-4 text-center text-gray-600 text-sm">
      &copy; 2024 Simulasi Kriptografi RSA - Enkripsi & Dekripsi TTD
    </div>
  </footer>

  <script>
    // Utility: Cek bilangan prima sederhana (efisien untuk bilangan kecil)
    function isPrime(num) {
      if (num < 2) return false;
      if (num === 2) return true;
      if (num % 2 === 0) return false;
      const sqrt = Math.floor(Math.sqrt(num));
      for (let i = 3; i <= sqrt; i += 2) {
        if (num % i === 0) return false;
      }
      return true;
    }

    // Hitung gcd (FPB) menggunakan Euclidean Algorithm
    function gcd(a, b) {
      while (b !== 0) {
        [a, b] = [b, a % b];
      }
      return a;
    }

    // Hitung modular inverse d dari e mod phi menggunakan Extended Euclidean Algorithm
    function modInverse(e, phi) {
      let [old_r, r] = [e, phi];
      let [old_s, s] = [1, 0];
      let [old_t, t] = [0, 1];
      while (r !== 0) {
        const quotient = Math.floor(old_r / r);
        [old_r, r] = [r, old_r - quotient * r];
        [old_s, s] = [s, old_s - quotient * s];
        [old_t, t] = [t, old_t - quotient * t];
      }
      if (old_s < 0) old_s += phi;
      return old_s;
    }

    // Modular exponentiation (base^exp mod mod) - untuk enkripsi dan dekripsi
    function modPow(base, exp, mod) {
      if (mod === 1) return 0;
      let result = 1n;
      let b = BigInt(base);
      let e = BigInt(exp);
      let m = BigInt(mod);
      b = b % m;
      while (e > 0) {
        if (e % 2n === 1n) {
          result = (result * b) % m;
        }
        e = e / 2n;
        b = (b * b) % m;
      }
      return result;
    }

    // Konversi string ke array angka (kode ASCII)
    function textToNumbers(text) {
      const arr = [];
      for (let i = 0; i < text.length; i++) {
        arr.push(text.charCodeAt(i));
      }
      return arr;
    }

    // Konversi array angka ke string
    function numbersToText(arr) {
      return arr.map((num) => String.fromCharCode(num)).join('');
    }

    // Enkripsi RSA: ciphertext = (plaintext^e) mod n
    // plaintext di sini adalah array angka (kode ASCII)
    function encryptRSA(plaintextArr, e, n) {
      return plaintextArr.map((m) => Number(modPow(m, e, n)));
    }

    // Dekripsi RSA: plaintext = (ciphertext^d) mod n
    function decryptRSA(ciphertextArr, d, n) {
      return ciphertextArr.map((c) => Number(modPow(c, d, n)));
    }

    // Parsing ciphertext string ke array angka
    // Format ciphertext: angka dipisah spasi, contoh: "123 45 67"
    function parseCiphertext(text) {
      return text
        .trim()
        .split(/\s+/)
        .map((v) => {
          const n = Number(v);
          if (isNaN(n)) throw new Error('Format ciphertext tidak valid');
          return n;
        });
    }

    // Update progress bar dan teks status
    function updateProgress(percent, text) {
      const bar = document.getElementById('progressBar');
      const txt = document.getElementById('progressText');
      bar.style.width = percent + '%';
      bar.setAttribute('aria-valuenow', percent);
      txt.textContent = text;
    }

    // Reset semua input dan output
    function resetAll() {
      document.getElementById('inputP').value = '';
      document.getElementById('inputQ').value = '';
      document.getElementById('inputE').value = '';
      document.getElementById('inputText').value = '';
      document.getElementById('outputText').value = '';
      document.getElementById('keyError').classList.add('hidden');
      updateProgress(0, 'Menunggu aksi pengguna...');
    }

    // Validasi input kunci publik RSA
    function validateKeys(p, q, e) {
      if (!isPrime(p)) {
        return 'Bilangan p harus bilangan prima dan ≥ 2.';
      }
      if (!isPrime(q)) {
        return 'Bilangan q harus bilangan prima dan ≥ 2.';
      }
      if (p === q) {
        return 'Bilangan p dan q tidak boleh sama.';
      }
      const n = p * q;
      const phi = (p - 1) * (q - 1);
      if (e <= 1 || e >= phi) {
        return 'Bilangan e harus > 1 dan < φ(n).';
      }
      if (gcd(e, phi) !== 1) {
        return 'Bilangan e harus relatif prima terhadap φ(n).';
      }
      return null;
    }

    // Event handlers
    document.getElementById('btnEncrypt').addEventListener('click', () => {
      const p = Number(document.getElementById('inputP').value);
      const q = Number(document.getElementById('inputQ').value);
      const e = Number(document.getElementById('inputE').value);
      const inputText = document.getElementById('inputText').value;

      const keyError = document.getElementById('keyError');
      keyError.classList.add('hidden');
      keyError.textContent = '';

      if (!inputText) {
        alert('Masukkan teks yang ingin dienkripsi.');
        return;
      }

      const err = validateKeys(p, q, e);
      if (err) {
        keyError.textContent = err;
        keyError.classList.remove('hidden');
        return;
      }

      updateProgress(10, 'Menghitung kunci privat...');
      setTimeout(() => {
        const n = p * q;
        const phi = (p - 1) * (q - 1);
        const d = modInverse(e, phi);

        updateProgress(40, 'Mengonversi teks ke angka...');
        setTimeout(() => {
          const plaintextArr = textToNumbers(inputText);

          updateProgress(70, 'Melakukan enkripsi RSA...');
          setTimeout(() => {
            const ciphertextArr = encryptRSA(plaintextArr, e, n);
            const ciphertextStr = ciphertextArr.join(' ');

            document.getElementById('outputText').value = ciphertextStr;
            updateProgress(100, 'Enkripsi selesai.');
            setTimeout(() => {
              updateProgress(0, 'Menunggu aksi pengguna...');
            }, 1500);
          }, 300);
        }, 300);
      }, 300);
    });

    document.getElementById('btnDecrypt').addEventListener('click', () => {
      const p = Number(document.getElementById('inputP').value);
      const q = Number(document.getElementById('inputQ').value);
      const e = Number(document.getElementById('inputE').value);
      const inputText = document.getElementById('inputText').value.trim();

      const keyError = document.getElementById('keyError');
      keyError.classList.add('hidden');
      keyError.textContent = '';

      if (!inputText) {
        alert('Masukkan ciphertext yang ingin didekripsi (angka dipisah spasi).');
        return;
      }

      const err = validateKeys(p, q, e);
      if (err) {
        keyError.textContent = err;
        keyError.classList.remove('hidden');
        return;
      }

      updateProgress(10, 'Menghitung kunci privat...');
      setTimeout(() => {
        const n = p * q;
        const phi = (p - 1) * (q - 1);
        const d = modInverse(e, phi);

        updateProgress(40, 'Memproses ciphertext...');
        setTimeout(() => {
          let ciphertextArr;
          try {
            ciphertextArr = parseCiphertext(inputText);
          } catch (ex) {
            alert('Format ciphertext tidak valid. Pastikan angka dipisah spasi.');
            updateProgress(0, 'Menunggu aksi pengguna...');
            return;
          }

          updateProgress(70, 'Melakukan dekripsi RSA...');
          setTimeout(() => {
            const plaintextArr = decryptRSA(ciphertextArr, d, n);
            const plaintextStr = numbersToText(plaintextArr);

            document.getElementById('outputText').value = plaintextStr;
            updateProgress(100, 'Dekripsi selesai.');
            setTimeout(() => {
              updateProgress(0, 'Menunggu aksi pengguna...');
            }, 1500);
          }, 300);
        }, 300);
      }, 300);
    });

    document.getElementById('btnReset').addEventListener('click', () => {
      if (
        confirm(
          'Apakah Anda yakin ingin menghapus semua input dan output?'
        )
      ) {
        resetAll();
      }
    });

    document.getElementById('btnExit').addEventListener('click', () => {
      if (
        confirm(
          'Apakah Anda yakin ingin menutup aplikasi ini? Jika tidak bisa menutup, silakan tutup tab browser secara manual.'
        )
      ) {
        try {
          window.close();
        } catch {
          alert(
            'Tidak dapat menutup jendela secara otomatis. Silakan tutup tab browser secara manual.'
          );
        }
      }
    });

    // Inisialisasi progress bar
    updateProgress(0, 'Menunggu aksi pengguna...');
  </script>
</body>
</html>
